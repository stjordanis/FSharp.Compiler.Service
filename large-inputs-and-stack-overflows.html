<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Large inputs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="F# Software Foundation; Microsoft; F# Contributors">

    <link rel="stylesheet" id="theme_link" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.6.0/materia/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>

    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
    <link type="text/css" rel="stylesheet" href="https://fsharp.github.io/fsharp-compiler-docs/content/navbar-fixed-left.css" />
    <link type="text/css" rel="stylesheet" href="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-default.css" />
    <link type="text/css" rel="stylesheet" href="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-custom.css" />
    <script type="text/javascript" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- BEGIN SEARCH BOX: this adds support for the search box -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.css" />
    <!-- END SEARCH BOX: this adds support for the search box -->
    
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-light bg-secondary fixed-left" id="fsdocs-nav">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse navbar-nav-scroll" id="navbarsExampleDefault">
            <a href="https://fsharp.github.io/fsharp-compiler-docs/"><img id="fsdocs-logo" src="https://fsharp.github.io/fsharp-compiler-docs/img/logo.png" /></a>
            <!-- BEGIN SEARCH BOX: this adds support for the search box -->
            <div id="header">
                <div class="searchbox" id="fsdocs-searchbox">
                    <label for="search-by">
                        <i class="fas fa-search"></i>
                    </label>
                    <input data-search-input="" id="search-by" type="search" placeholder="Search..." />
                    <span data-search-clear="">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>

            <!-- END SEARCH BOX: this adds support for the search box -->
            <ul class="navbar-nav">
                <li class="nav-header">Links</li>
                <li class="nav-item" id="fsdocs-license-link"><a class="nav-link" href="https://github.com/dotnet/fsharp/blob/main/License.txt">License</a></li>
                <li class="nav-item" id="fsdocs-release-notes-link"><a class="nav-link" href="https://github.com/dotnet/fsharp/blob/main/release-notes.md">Release Notes</a></li>
                <li class="nav-item" id="fsdocs-repository-link"><a class="nav-link" href="https://github.com/dotnet/fsharp/">Source Repository</a></li>
                <li class="nav-header">
  Compiler Internals
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/overview.html">
    Overview
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/coding-standards.html">
    Coding standards
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/diagnostics.html">
    Diagnostics
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/debug-emit.html">
    Debug emit
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/optimizations.html">
    Optimizations
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/large-inputs-and-stack-overflows.html">
    Large inputs
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/memory-usage.html">
    Memory usage
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/compiler-startup-performance.html">
    Startup Performance
  </a>
</li>             
<li class="nav-header">
  Language Service Internals
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/tooling-features.html">
    Overview
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/project-builds.html">
    Project builds
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/caches.html">
    FSharpChecker caches
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/react.html">
    Incrementality
  </a>
</li>             
<li class="nav-header">
  FSharp.Compiler.Service
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/tokenizer.html">
    Tutorial: Tokenizing
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/untypedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/symbols.html">
    Tutorial: Symbols
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/editor.html">
    Tutorial: Editor services
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/typedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/project.html">
    Tutorial: Project analysis
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/interactive.html">
    Tutorial: Hosted execution
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/compiler.html">
    Tutorial: Hosting the compiler
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/corelib.html">
    Notes on FSharp.Core
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/filesystem.html">
    IFileSystem
  </a>
</li>             
<li class="nav-header">
  FSharp.Core
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fsharp-core-notes.html">
    Guidance
  </a>
</li>
                <li class="nav-header">
  API Reference
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/reference/index.html">
    All Namespaces
  </a>
</li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <div class="masthead">
            <h3 class="muted"><a href="https://fsharp.github.io/fsharp-compiler-docs/">F# Compiler Guide</a></h3>
        </div>
        <hr />
        <div class="container" id="fsdocs-content">
            
<h1><a name="Processing-large-inputs-without-stack-overflows" class="anchor" href="#Processing-large-inputs-without-stack-overflows">Processing large inputs without stack overflows</a></h1>
<p>The compiler accepts large inputs such as:</p>
<ul>
<li>Large literals, such as <code>let str = "a1" + "a2" + ... + "a1000"</code></li>
<li>Large array expressions</li>
<li>Large list expressions</li>
<li>Long lists of sequential expressions</li>
<li>Long lists of bindings, such as <code>let v1 = e1 in let v2 = e2 in ....</code></li>
<li>Long sequences of <code>if .. then ... else</code> expressions</li>
<li>Long sequences of <code>match x with ... | ...</code> expressions</li>
<li>Combinations of these</li>
</ul>
<p>The compiler performs constant folding for large constants so there are no costs to using them at runtime. However, this is subject to a machine's stack size when compiling, leading to <code>StackOverflow</code> exceptions if those constants are very large. The same can be observed for certain kinds of array, list, or sequence expressions. This appears to be more prominent when compiling on macOS because macOS has a smaller stack size.</p>
<p>Many sources of <code>StackOverflow</code> exceptions prior to F# 4.7 when processing these kinds of constructs were resolved by processing them on the heap via continuation passing techniques. This avoids filling data on the stack and appears to have negligible effects on overall throughout or memory usage of the compiler.</p>
<p>There are two techniques to deal with this</p>
<ol>
<li>Linearizing processing of specific input shapes, keeping stacks small</li>
<li>Using stack guards to simply temporarily move to a new thread when a certain threshold is reached.</li>
</ol>
<h2><a name="Linearizing-processing-if-certain-inputs" class="anchor" href="#Linearizing-processing-if-certain-inputs">Linearizing processing if certain inputs</a></h2>
<p>Aside from array expressions, most of the previously-listed inputs are called "linear" expressions. This means that there is a single linear hole in the shape of expressions. For example:</p>
<ul>
<li><code>expr :: HOLE</code> (list expressions or other right-linear constructions)</li>
<li><code>expr; HOLE</code> (sequential expressions)</li>
<li><code>let v = expr in HOLE</code> (let expressions)</li>
<li><code>if expr then expr else HOLE</code> (conditional expression)</li>
<li><code>match expr with pat[vs] -&gt; e1[vs] | pat2 -&gt; HOLE</code> (for example, <code>match expr with Some x -&gt; ... | None -&gt; ...</code>)</li>
</ul>
<p>Processing these constructs with continuation passing is more difficult than a more "natural" approach that would use the stack.</p>
<p>For example, consider the following contrived example:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">and</span> <span class="id">remapLinearExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenv</span> <span class="id">expr</span> <span class="id">contf</span> <span class="o">=</span>
    <span class="k">match</span> <span class="id">expr</span> <span class="k">with</span>
    <span class="pn">|</span> <span class="id">Expr</span><span class="pn">.</span><span class="id">Let</span> <span class="pn">(</span><span class="id">bind</span><span class="pn">,</span> <span class="id">bodyExpr</span><span class="pn">,</span> <span class="id">m</span><span class="pn">,</span> <span class="id">_</span><span class="pn">)</span> <span class="k">-&gt;</span>
        <span class="o">..</span><span class="pn">.</span>
        <span class="c">// tailcall for the linear position</span>
        <span class="id">remapLinearExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenvinner</span> <span class="id">bodyExpr</span> <span class="pn">(</span><span class="id">contf</span> <span class="o">&lt;&lt;</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">bodyExpr&#39;</span> <span class="k">-&gt;</span>
            <span class="o">..</span><span class="pn">.</span><span class="pn">)</span><span class="pn">)</span>

    <span class="pn">|</span> <span class="id">Expr</span><span class="pn">.</span><span class="id">Sequential</span> <span class="pn">(</span><span class="id">expr1</span><span class="pn">,</span> <span class="id">expr2</span><span class="pn">,</span> <span class="id">dir</span><span class="pn">,</span> <span class="id">spSeq</span><span class="pn">,</span> <span class="id">m</span><span class="pn">)</span>  <span class="k">-&gt;</span>
        <span class="o">..</span><span class="pn">.</span>
        <span class="c">// tailcall for the linear position</span>
        <span class="id">remapLinearExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenv</span> <span class="id">expr2</span> <span class="pn">(</span><span class="id">contf</span> <span class="o">&lt;&lt;</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">expr2&#39;</span> <span class="k">-&gt;</span>
            <span class="o">..</span><span class="pn">.</span><span class="pn">)</span><span class="pn">)</span>

    <span class="pn">|</span> <span class="id">LinearMatchExpr</span> <span class="pn">(</span><span class="id">spBind</span><span class="pn">,</span> <span class="id">exprm</span><span class="pn">,</span> <span class="id">dtree</span><span class="pn">,</span> <span class="id">tg1</span><span class="pn">,</span> <span class="id">expr2</span><span class="pn">,</span> <span class="id">sp2</span><span class="pn">,</span> <span class="id">m2</span><span class="pn">,</span> <span class="id">ty</span><span class="pn">)</span> <span class="k">-&gt;</span>
        <span class="o">..</span><span class="pn">.</span>
        <span class="c">// tailcall for the linear position</span>
        <span class="id">remapLinearExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenv</span> <span class="id">expr2</span> <span class="pn">(</span><span class="id">contf</span> <span class="o">&lt;&lt;</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">expr2&#39;</span> <span class="k">-&gt;</span>  <span class="o">..</span><span class="pn">.</span><span class="pn">)</span><span class="pn">)</span>

    <span class="pn">|</span> <span class="id">LinearOpExpr</span> <span class="pn">(</span><span class="id">op</span><span class="pn">,</span> <span class="id">tyargs</span><span class="pn">,</span> <span class="id">argsFront</span><span class="pn">,</span> <span class="id">argLast</span><span class="pn">,</span> <span class="id">m</span><span class="pn">)</span> <span class="k">-&gt;</span>
        <span class="o">..</span><span class="pn">.</span>
        <span class="c">// tailcall for the linear position</span>
        <span class="id">remapLinearExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenv</span> <span class="id">argLast</span> <span class="pn">(</span><span class="id">contf</span> <span class="o">&lt;&lt;</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">argLast&#39;</span> <span class="k">-&gt;</span> <span class="o">..</span><span class="pn">.</span><span class="pn">)</span><span class="pn">)</span>

    <span class="pn">|</span> <span class="id">_</span> <span class="k">-&gt;</span> <span class="id">contf</span> <span class="pn">(</span><span class="id">remapExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenv</span> <span class="id">e</span><span class="pn">)</span>

<span class="k">and</span> <span class="id">remapExpr</span> <span class="pn">(</span><span class="id">g</span><span class="pn">:</span> <span class="id">TcGlobals</span><span class="pn">)</span> <span class="pn">(</span><span class="id">compgen</span><span class="pn">:</span><span class="id">ValCopyFlag</span><span class="pn">)</span> <span class="pn">(</span><span class="id">tmenv</span><span class="pn">:</span><span class="id">Remap</span><span class="pn">)</span> <span class="id">expr</span> <span class="o">=</span>
    <span class="k">match</span> <span class="id">expr</span> <span class="k">with</span>
    <span class="o">..</span><span class="pn">.</span>
    <span class="pn">|</span> <span class="id">LinearOpExpr</span> <span class="id">_</span>
    <span class="pn">|</span> <span class="id">LinearMatchExpr</span> <span class="id">_</span>
    <span class="pn">|</span> <span class="id">Expr</span><span class="pn">.</span><span class="id">Sequential</span> <span class="id">_</span>
    <span class="pn">|</span> <span class="id">Expr</span><span class="pn">.</span><span class="id">Let</span> <span class="id">_</span> <span class="k">-&gt;</span> <span class="id">remapLinearExpr</span> <span class="id">g</span> <span class="id">compgen</span> <span class="id">tmenv</span> <span class="id">expr</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">x</span> <span class="k">-&gt;</span> <span class="id">x</span><span class="pn">)</span>
</code></pre>
<p>The <code>remapExpr</code> operation becomes two functions, <code>remapExpr</code> (for non-linear cases) and <code>remapLinearExpr</code> (for linear cases). <code>remapLinearExpr</code> uses tailcalls for constructs in the <code>HOLE</code> positions mentioned previously, passing the result to the continuation.</p>
<p>Some common aspects of this style of programming are:</p>
<ul>
<li>The tell-tale use of <code>contf</code> (continuation function)</li>
<li>The processing of the body expression <code>e</code> of a let-expression is tail-recursive, if the next construct is also a let-expression.</li>
<li>The processing of the <code>e2</code> expression of a sequential-expression is tail-recursive</li>
<li>The processing of the second expression in a cons is tail-recursive</li>
</ul>
<p>The previous example is considered incomplete, because arbitrary <em>combinations</em> of <code>let</code> and sequential expressions aren't going to be dealt with in a tail-recursive way. The compiler generally tries to do these combinations as well.</p>
<h2><a name="Stack-Guards" class="anchor" href="#Stack-Guards">Stack Guards</a></h2>
<p>The <code>StackGuard</code> type is used to count synchronous recursive processing and move to a new thread if a limit is reached. Compilation globals are re-installed. Sample:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="id">TcStackGuardDepth</span> <span class="o">=</span> <span class="id">StackGuard</span><span class="pn">.</span><span class="id">GetDepthOption</span> <span class="s">&quot;Tc&quot;</span>

<span class="o">..</span><span class="pn">.</span>
   <span class="id">stackGuard</span> <span class="o">=</span> <span class="id">StackGuard</span><span class="pn">(</span><span class="id">TcMaxStackGuardDepth</span><span class="pn">)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="o">..</span><span class="o">..</span>

<span class="k">and</span> <span class="id">TcExpr</span> <span class="id">cenv</span> <span class="id">ty</span> <span class="pn">(</span><span class="id">env</span><span class="pn">:</span> <span class="id">TcEnv</span><span class="pn">)</span> <span class="id">tpenv</span> <span class="pn">(</span><span class="id">expr</span><span class="pn">:</span> <span class="id">SynExpr</span><span class="pn">)</span> <span class="o">=</span>

    <span class="c">// Guard the stack for deeply nested expressions</span>
    <span class="id">cenv</span><span class="pn">.</span><span class="id">stackGuard</span><span class="pn">.</span><span class="id">Guard</span> <span class="o">&lt;|</span> <span class="k">fun</span> <span class="pn">(</span><span class="pn">)</span> <span class="k">-&gt;</span>

    <span class="o">..</span><span class="pn">.</span>
</code></pre>
<p>Note stack guarding doesn't result in a tailcall so will appear in recursive stack frames, because a counter must be decremented after the call. This is used systematically for recursive processing of:</p>
<ul>
<li>SyntaxTree SynExpr</li>
<li>TypedTree Expr</li>
</ul>
<p>We don't use it for other inputs.</p>

            
        </div>

        <!-- BEGIN SEARCH BOX: this adds support for the search box -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.css" />
        <script type="text/javascript">var fsdocs_search_baseurl = 'https://fsharp.github.io/fsharp-compiler-docs/';</script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.8/lunr.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.min.js"></script>
        <script type="text/javascript" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-search.js"></script>
        <!-- END SEARCH BOX: this adds support for the search box -->
    </div>
</body>

</html>