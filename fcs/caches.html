<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>FSharpChecker caches</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="F# Software Foundation; Microsoft; F# Contributors">

    <link rel="stylesheet" id="theme_link" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.6.0/materia/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>

    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
    <link type="text/css" rel="stylesheet" href="https://fsharp.github.io/fsharp-compiler-docs/content/navbar-fixed-left.css" />
    <link type="text/css" rel="stylesheet" href="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-default.css" />
    <link type="text/css" rel="stylesheet" href="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-custom.css" />
    <script type="text/javascript" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- BEGIN SEARCH BOX: this adds support for the search box -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.css" />
    <!-- END SEARCH BOX: this adds support for the search box -->
    
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-light bg-secondary fixed-left" id="fsdocs-nav">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse navbar-nav-scroll" id="navbarsExampleDefault">
            <a href="https://fsharp.github.io/fsharp-compiler-docs/"><img id="fsdocs-logo" src="https://fsharp.github.io/fsharp-compiler-docs/img/logo.png" /></a>
            <!-- BEGIN SEARCH BOX: this adds support for the search box -->
            <div id="header">
                <div class="searchbox" id="fsdocs-searchbox">
                    <label for="search-by">
                        <i class="fas fa-search"></i>
                    </label>
                    <input data-search-input="" id="search-by" type="search" placeholder="Search..." />
                    <span data-search-clear="">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>

            <!-- END SEARCH BOX: this adds support for the search box -->
            <ul class="navbar-nav">
                <li class="nav-header">Links</li>
                <li class="nav-item" id="fsdocs-license-link"><a class="nav-link" href="https://github.com/dotnet/fsharp/blob/main/License.txt">License</a></li>
                <li class="nav-item" id="fsdocs-release-notes-link"><a class="nav-link" href="https://github.com/dotnet/fsharp/blob/main/release-notes.md">Release Notes</a></li>
                <li class="nav-item" id="fsdocs-repository-link"><a class="nav-link" href="https://github.com/dotnet/fsharp/">Source Repository</a></li>
                <li class="nav-header">
  Compiler Internals
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/overview.html">
    Overview
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/coding-standards.html">
    Coding standards
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/diagnostics.html">
    Diagnostics
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/debug-emit.html">
    Debug emit
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/optimizations.html">
    Optimizations
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/large-inputs-and-stack-overflows.html">
    Large inputs
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/memory-usage.html">
    Memory usage
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/compiler-startup-performance.html">
    Startup Performance
  </a>
</li>             
<li class="nav-header">
  Language Service Internals
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/tooling-features.html">
    Overview
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/project-builds.html">
    Project builds
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/caches.html">
    FSharpChecker caches
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/react.html">
    Incrementality
  </a>
</li>             
<li class="nav-header">
  FSharp.Compiler.Service
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/tokenizer.html">
    Tutorial: Tokenizing
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/untypedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/symbols.html">
    Tutorial: Symbols
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/editor.html">
    Tutorial: Editor services
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/typedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/project.html">
    Tutorial: Project analysis
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/interactive.html">
    Tutorial: Hosted execution
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/compiler.html">
    Tutorial: Hosting the compiler
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/corelib.html">
    Notes on FSharp.Core
  </a>
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/filesystem.html">
    IFileSystem
  </a>
</li>             
<li class="nav-header">
  FSharp.Core
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fsharp-core-notes.html">
    Guidance
  </a>
</li>
                <li class="nav-header">
  API Reference
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/reference/index.html">
    All Namespaces
  </a>
</li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <div class="masthead">
            <h3 class="muted"><a href="https://fsharp.github.io/fsharp-compiler-docs/">F# Compiler Guide</a></h3>
        </div>
        <hr />
        <div class="container" id="fsdocs-content">
            
<h1><a name="Compiler-Services-Notes-on-the-FSharpChecker-caches" class="anchor" href="#Compiler-Services-Notes-on-the-FSharpChecker-caches">Compiler Services: Notes on the FSharpChecker caches</a></h1>
<p>This is a design note on the FSharpChecker component and its caches.  See also the notes on the <a href="queue.html">FSharpChecker operations queue</a></p>
<p>Each FSharpChecker object maintains a set of caches.  These are</p>
<ul>
<li>
<p><code>scriptClosureCache</code> - an MRU cache of default size <code>projectCacheSize</code> that caches the
computation of GetProjectOptionsFromScript. This computation can be lengthy as it can involve processing the transitive closure
of all <code>#load</code> directives, which in turn can mean parsing an unbounded number of script files</p>
</li>
<li>
<p><code>incrementalBuildersCache</code> - an MRU cache of projects where a handle is being kept to their incremental checking state,
of default size <code>projectCacheSize</code> (= 3 unless explicitly set as a parameter).
The "current background project" (see the <a href="queue.html">FSharpChecker operations queue</a>)
will be one of these projects.  When analyzing large collections of projects, this cache usually occupies by far the most memory.
Increasing the size of this cache can dramatically decrease incremental computation of project-wide checking, or of checking
individual files within a project, but can very greatly increase memory usage.</p>
</li>
<li><p><code>braceMatchCache</code> - an MRU cache of size <code>braceMatchCacheSize</code> (default = 5) keeping the results of calls to MatchBraces, keyed by filename, source and project options.</p></li>
<li>
<p><code>parseFileCache</code> - an MRU cache of size <code>parseFileCacheSize</code> (default = 2) keeping the results of ParseFile,
keyed by filename, source and project options.</p>
</li>
<li>
<p><code>checkFileInProjectCache</code> - an MRU cache of size <code>incrementalTypeCheckCacheSize</code> (default = 5) keeping the results of
ParseAndCheckFileInProject, CheckFileInProject and/or CheckFileInProjectIfReady. This is keyed by filename, file source
and project options.  The results held in this cache are only returned if they would reflect an accurate parse and check of the
file.</p>
</li>
<li><p><code>getToolTipTextCache</code> - an aged lookup cache of strong size <code>getToolTipTextSize</code> (default = 5) computing the results of GetToolTipText.</p></li>
<li>
<p><code>ilModuleReaderCache</code> - an aged lookup of weak references to "readers" for references .NET binaries. Because these
are all weak references, you can generally ignore this cache, since its entries will be automatically collected.
Strong references to binary readers will be kept by other FCS data structures, e.g. any project checkers, symbols or project checking results.</p>
<p>In more detail, the bytes for referenced .NET binaries are read into memory all at once, eagerly. Files are not left
open or memory-mapped when using FSharpChecker (as opposed to FsiEvaluationSession, which loads assemblies using reflection).
The purpose of this cache is mainly to ensure that while setting up compilation, the reads of mscorlib, FSharp.Core and so on
amortize cracking the DLLs.</p>
</li>
<li>
<p><code>frameworkTcImportsCache</code> - an aged lookup of strong size 8 which caches the process of setting up type checking against a set of system
components (e.g. a particular version of mscorlib, FSharp.Core and other system DLLs).  These resources are automatically shared between multiple
project checkers which happen to reference the same set of system assemblies.</p>
</li>
</ul>
<p>Profiling the memory used by the various caches can be done by looking for the corresponding static roots in memory profiling traces.</p>
<p>The sizes of some of these caches can be adjusted by giving parameters to FSharpChecker.  Unless otherwise noted,
the cache sizes above indicate the "strong" size of the cache, where memory is held regardless of the memory
pressure on the system. Some of the caches can also hold "weak" references which can be collected at will by the GC.</p>
<blockquote>
<p>Note: Because of these caches, you should generally use one global, shared FSharpChecker for everything in an IDE application.</p>
</blockquote>
<h2><a name="Low-Memory-Condition" class="anchor" href="#Low-Memory-Condition">Low-Memory Condition</a></h2>
<p>Version 1.4.0.8 added a "maximum memory" limit specified by the <code>MaxMemory</code> property on FSharpChecker (in MB). If an FCS project operation
is performed (see <code>CheckMaxMemoryReached</code> in <code>service.fs</code>) and <code>System.GC.GetTotalMemory(false)</code> reports a figure greater than this, then
the strong sizes of all FCS caches are reduced to either 0 or 1.  This happens for the remainder of the lifetime of the FSharpChecker object.
In practice this will still make tools like the Visual Studio F# Power Tools usable, but some operations like renaming across multiple
projects may take substantially longer.</p>
<p>By default the maximum memory trigger is disabled, see <code>maxMBDefault</code> in <code>service.fs</code>.</p>
<p>Reducing the FCS strong cache sizes does not guarantee there will be enough memory to continue operations - even holding one project
strongly may exceed a process memory budget. It just means FCS may hold less memory strongly.</p>
<p>If you do not want the maximum memory limit to apply then set MaxMemory to System.Int32.MaxValue.</p>
<h2><a name="Summary" class="anchor" href="#Summary">Summary</a></h2>
<p>In this design note, you learned that the FSharpChecker component keeps a set of caches in order to support common
incremental analysis scenarios reasonably efficiently. They correspond roughly to the original caches and sizes
used by the Visual F# Tools, from which the FSharpChecker component derives.</p>
<p>In long running, highly interactive, multi-project scenarios you should carefully
consider the cache sizes you are using and the tradeoffs involved between incremental multi-project checking and memory usage.</p>

            
        </div>

        <!-- BEGIN SEARCH BOX: this adds support for the search box -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.css" />
        <script type="text/javascript">var fsdocs_search_baseurl = 'https://fsharp.github.io/fsharp-compiler-docs/';</script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.8/lunr.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.min.js"></script>
        <script type="text/javascript" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-search.js"></script>
        <!-- END SEARCH BOX: this adds support for the search box -->
    </div>
</body>

</html>